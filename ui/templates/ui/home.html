{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FoodLens - Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400&family=Raleway:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
</head>
<body>
  <header class="site-header">
  <div class="header-inner">
    <div class="brand">
      <img class="logo" src="{% static 'assets/logo.svg' %}" alt="FoodLens logo">
      <span>FOOD</span><span class="orange">LENS</span>
    </div>

    <nav class="nav-links">
      <a href="{% url 'what_is_foodlens' %}" class="nav-link">What is FoodLens?</a>
    </nav>
  </div>
</header>

  <main class="container">
    <section class="card" aria-labelledby="uploadTitle">
      <h2 id="uploadTitle">Upload an Image</h2>

      <div class="field">
        <label for="imageInput">Image</label>
        <input type="file" id="imageInput" accept="image/*">
      </div>

      <div class="preview-container" aria-live="polite">
        <img id="previewImage" class="preview-image is-hidden" alt="" />
        <div class="preview-actions is-hidden" id="previewActions">
          <button type="button" class="btn btn-secondary" id="replaceBtn">Replace Image</button>
          <button type="button" class="btn btn-ghost" id="clearBtn">Remove</button>
        </div>
      </div>

      <div class="field">
        <label for="desc">How to Use FoodLens</label>
        <div id="desc" class="instructions instructions-list">
          <ol>
            <li>
              Pick the perishable food item of your choice.
              <span class="note">*Our AI model is currently trained only for apples, bananas, bitter gourds, capsicums, cucumbers, okras, oranges, potatoes, & tomatoes.*</span>
              <span class="note">*Uploading other items may result in inaccurate results.*</span>
            </li>
            <li>Upload <strong>one</strong> image of the perishable food item you selected.</li>
            <li>Click <em>Submit</em> when you're ready to see the quality of your food item!</li>
          </ol>
        </div>
      </div>

      <button class="btn" id="submitBtn">Submit</button>

      <!-- Placeholder for prediction result -->
      <div id="result" class="prediction-result" style="margin-top: 20px;"></div>

    </section>
  </main>

  <script>
    const submitBtn = document.getElementById('submitBtn');
    const imageInput = document.getElementById('imageInput');
    const resultDiv = document.getElementById('result');

    submitBtn.addEventListener('click', async () => {
  if (!imageInput.files.length) {
    alert("Please upload an image first!");
    return;
  }

  const file = imageInput.files[0];
  const formData = new FormData();
  formData.append('image', file);

  const response = await fetch('/predict/', {
    method: 'POST',
    body: formData
  });

  const data = await response.json();

  if (data.error) {
    resultDiv.innerHTML = `<p style="color:red">${data.error}</p>`;
    return;
  }

  // Display top 3 predictions
  resultDiv.innerHTML = `<h3>Top 3 Prediction Result:</h3>`;
  data.predictions.forEach((pred, idx) => {
    resultDiv.innerHTML += `<p>${idx+1}. Class: <strong>${pred.label}</strong>, Confidence: <strong>${(pred.prob*100).toFixed(2)}%</strong></p>`;
  });

  // Add feedback form linked to this image (image_id returned by server)
  if (data.image_id) {
    resultDiv.innerHTML += `
      <div id="feedbackBox" style="margin-top:16px;border-top:1px solid #eee;padding-top:12px;">
        <h4>Was this helpful?</h4>
        <div>
          <label><input type="radio" name="helpful" value="true"> Yes</label>
          <label style="margin-left:12px;"><input type="radio" name="helpful" value="false"> No</label>
        </div>
        <div style="margin-top:8px;">
          <textarea id="feedbackExplanation" rows="3" style="width:100%;" placeholder="Optional: tell us more"></textarea>
        </div>
        <div style="margin-top:8px;">
          <button id="feedbackSubmitBtn" class="btn">Submit feedback</button>
          <span id="feedbackMessage" style="margin-left:8px;"></span>
        </div>
      </div>
    `;

    const feedbackSubmitBtn = document.getElementById('feedbackSubmitBtn');
    feedbackSubmitBtn.addEventListener('click', async () => {
      const helpfulInput = document.querySelector('input[name="helpful"]:checked');
      if (!helpfulInput) {
        document.getElementById('feedbackMessage').innerText = 'Please choose Yes or No.';
        return;
      }
      const helpfulVal = helpfulInput.value === 'true';
      const explanation = document.getElementById('feedbackExplanation').value;

      const resp = await fetch('/feedback/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image_id: data.image_id, helpful: helpfulVal, explanation })
      });
      const json = await resp.json();
      if (json.success) {
        document.getElementById('feedbackMessage').innerText = 'Thanks for your feedback!';
        feedbackSubmitBtn.disabled = true;
      } else {
        document.getElementById('feedbackMessage').innerText = json.error || 'Error submitting feedback';
      }
    });
  }
});
    
    const previewImage = document.getElementById('previewImage');
    const previewActions = document.getElementById('previewActions');
    const replaceBtn = document.getElementById('replaceBtn');
    const clearBtn = document.getElementById('clearBtn');

    function showPreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.classList.remove('is-hidden');
        previewActions.classList.remove('is-hidden');
      };
      reader.readAsDataURL(file);
    }

    function clearPreview() {
      imageInput.value = '';
      previewImage.src = '';
      previewImage.classList.add('is-hidden');
      previewActions.classList.add('is-hidden');
    }

    imageInput.addEventListener('change', () => {
      const file = imageInput.files && imageInput.files[0];
      if (file) showPreview(file);
      else clearPreview();
    });

    replaceBtn.addEventListener('click', () => {
      // Let user pick a different image
      imageInput.click();
    });

    clearBtn.addEventListener('click', clearPreview);
  </script>
</body>
</html>
