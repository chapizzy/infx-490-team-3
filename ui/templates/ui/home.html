{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FoodLens - Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400&family=Raleway:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">

  <!-- Inline styles for the new result modal (keeps styling consistent with instruction modal) -->
  <style>
    /* ===== RESULT MODAL ===== */
    #resultModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none; /* hidden by default */
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      z-index: 1050;
      padding: 24px;
      backdrop-filter: blur(1px);
    }

    #resultModal .modal-content {
      background: #ffffff;
      border-radius: 16px;
      padding: 28px 36px;
      max-width: 560px; /* auto-size-ish (you said auto) */
      width: 100%;
      box-shadow: 0 18px 40px rgba(0,0,0,.08);
      position: relative;
      max-height: none;
      overflow-y: visible;
      font-family: var(--font-body);
      color: var(--text);
    }

    #resultModal h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-family: var(--font-title);
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary-teal);
    }

    #resultModal .close-result {
      position: absolute;
      top: 14px;
      right: 14px;
      background: transparent;
      border: none;
      font-size: 22px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text);
      transition: color 0.2s ease;
    }

    #resultModal .close-result:hover { color: var(--accent-orange); }

    /* keep freshness styles inside modal consistent */
    #resultModal .freshness-container { margin-top: 8px; }
    #resultModal .freshness-label { display:block; font-weight:700; margin-bottom:6px; color:var(--primary-teal); font-family:var(--font-title); }
    #resultModal .freshness-bar { width:100%; background:#f2f2f2; border-radius:8px; height:25px; overflow:hidden; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); }
    #resultModal .freshness-bar__fill { height:100%; width:0%; background-color:red; transition: width 1.8s cubic-bezier(0.25,0.6,0.5,1), background-color 1.8s cubic-bezier(0.25,0.6,0.5,1); }
    #resultModal .freshness-legend { margin-top:8px; font-weight:700; color:var(--text); }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="brand">
        <img class="logo" src="{% static 'assets/logo.svg' %}" alt="FoodLens logo">
        <span>FOOD</span><span class="orange">LENS</span>
      </div>
      <nav class="nav-links">
        <a href="{% url 'what_is_foodlens' %}" class="nav-link">What is FoodLens?</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="card" aria-labelledby="uploadTitle">
      <h2 id="uploadTitle">Upload an Image</h2>

      <div class="field">
        <label for="imageInput">Image</label>
        <input type="file" id="imageInput" accept="image/*">
      </div>

      <div class="preview-container" aria-live="polite">
        <img id="previewImage" class="preview-image is-hidden" alt="" />
        <div class="preview-actions is-hidden" id="previewActions">
          <button type="button" class="btn btn-secondary" id="replaceBtn">Replace Image</button>
          <button type="button" class="btn btn-ghost" id="clearBtn">Remove</button>
        </div>
      </div>

      <!-- ===== Image-based Produce Selector (replaces dropdown) ===== -->
      <div class="field">
        <label>Select Produce Type (Optional)</label>

        <div class="produce-grid">
          <!-- Apple -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="apple">
            <div class="produce-card">
              <img src="{% static 'assets/Apple.svg' %}" alt="Apple" class="produce-image">
            </div>
          </label>

          <!-- Banana -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="banana">
            <div class="produce-card">
              <img src="{% static 'assets/Banana.svg' %}" alt="Banana" class="produce-image">
            </div>
          </label>

          <!-- Bell Pepper -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="bellpepper">
            <div class="produce-card">
              <img src="{% static 'assets/Bell Pepper.svg' %}" alt="Bell Pepper" class="produce-image">
            </div>
          </label>

          <!-- Bitter Gourd -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="bittergourd">
            <div class="produce-card">
              <img src="{% static 'assets/Bitter Gourd.svg' %}" alt="Bitter Gourd" class="produce-image">
            </div>
          </label>

          <!-- Cucumber -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="cucumber">
            <div class="produce-card">
              <img src="{% static 'assets/Cucumber.svg' %}" alt="Cucumber" class="produce-image">
            </div>
          </label>

          <!-- Okra -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="okra">
            <div class="produce-card">
              <img src="{% static 'assets/Okra.svg' %}" alt="Okra" class="produce-image">
            </div>
          </label>

          <!-- Orange -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="orange">
            <div class="produce-card">
              <img src="{% static 'assets/Orange.svg' %}" alt="Orange" class="produce-image">
            </div>
          </label>

          <!-- Potato -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="potato">
            <div class="produce-card">
              <img src="{% static 'assets/Potato.svg' %}" alt="Potato" class="produce-image">
            </div>
          </label>

          <!-- Tomato -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="tomato">
            <div class="produce-card">
              <img src="{% static 'assets/Tomato.svg' %}" alt="Tomato" class="produce-image">
            </div>
          </label>

          <!-- I'm Unsure (acts like 'no specific type') -->
          <label class="produce-option">
            <input type="radio" name="produce_type" value="">
            <div class="produce-card">
              <img src="{% static 'assets/Unsure.svg' %}" alt="I'm Unsure" class="produce-image">
            </div>
          </label>
        </div>
      </div>

      <button class="btn" id="submitBtn">Submit</button>

      <!-- NOTE: on-page #result and #feedbackBox removed and moved into the modal below.
           The feedback UI still uses the same IDs so your existing JS works. -->

    </section>
  </main>

  <!-- ===== Help / Instruction Popup ===== -->
  <button id="helpBtn">?</button>

  <!-- Modal always rendered, hide initially if show_popup is false -->
  <div id="instructionModal" {% if not show_popup %}style="display:none"{% endif %}>
    <div class="modal-content">
      <button class="close-btn">&times;</button>
      <h3>How to Use FoodLens</h3>
      <ol>
        <li>
          Pick the perishable food item of your choice.
          <span class="note">*Our AI model is currently trained only for apples, bananas, bitter gourds, capsicums, cucumbers, okras, oranges, potatoes, & tomatoes.*</span>
          <span class="note">*Uploading other items may result in inaccurate results.*</span>
        </li>
        <li>Upload <strong>one</strong> image of the perishable food item you selected.</li>
        <li>(Optional) Select the produce type to get a specific freshness score.</li>
        <li>Click <em>Submit</em> when you're ready to see the quality of your food item!</li>
      </ol>
      <div class="dont-show">
        <input type="checkbox" id="dontShowAgain">
        <label for="dontShowAgain">Don't show again</label>
      </div>
    </div>
  </div>

  <!-- ===== Auth Modal (login / signup) ===== -->
  <div id="authModal">
    <div class="auth-card">
      <button class="auth-close">&times;</button>
      <h3 id="authTitle">Welcome — Sign in</h3>

      <div id="authError" class="error hidden"></div>

      <div id="loginForm">
        <div class="auth-field">
          <label for="loginUsername">Username</label>
          <input id="loginUsername" type="text" name="username" autocomplete="username">
        </div>
        <div class="auth-field">
          <label for="loginPassword">Password</label>
          <input id="loginPassword" type="password" name="password" autocomplete="current-password">
        </div>
        <div class="auth-actions">
          <button id="loginBtn" class="btn">Sign in</button>
          <div class="auth-toggle" id="showSignup">Create account</div>
        </div>
      </div>

      <div id="signupForm" class="hidden">
        <div class="auth-field">
          <label for="signupUsername">Username</label>
          <input id="signupUsername" type="text" name="username" autocomplete="username">
        </div>
        <div class="auth-field">
          <label for="signupEmail">Email (optional)</label>
          <input id="signupEmail" type="email" name="email" autocomplete="email">
        </div>
        <div class="auth-field">
          <label for="signupPassword">Password</label>
          <input id="signupPassword" type="password" name="password" autocomplete="new-password">
        </div>
        <div class="auth-actions">
          <button id="signupBtn" class="btn">Create account</button>
          <div class="auth-toggle" id="showLogin">Have an account?</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== NEW: Result Modal (contains both results and feedback) ===== -->
  <div id="resultModal" aria-hidden="true">
    <div class="modal-content">
      <button class="close-result">&times;</button>

      <!-- RESULT will be injected into this body -->
      <div id="resultModalBody">
        <!-- We'll dynamically populate: either segmented_result bar or top-3 predictions -->
      </div>

      <!-- ===== Feedback =====
           Moved here (same markup/IDs as before so existing JS works) -->
      <div id="feedbackBox" style="display:none; margin-top:16px;border-top:1px solid #eee;padding-top:12px;">
        <h4>Was this helpful?</h4>
        <div>
          <label><input type="radio" name="helpful" value="true"> Yes</label>
          <label style="margin-left:12px;"><input type="radio" name="helpful" value="false"> No</label>
        </div>
        <div style="margin-top:8px;">
          <textarea id="feedbackExplanation" rows="3" style="width:100%;" placeholder="Optional: tell us more"></textarea>
        </div>
        <div style="margin-top:8px;">
          <button id="feedbackSubmitBtn" class="btn">Submit feedback</button>
          <span id="feedbackMessage" style="margin-left:8px;"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Image + Prediction JS =====
    const submitBtn = document.getElementById('submitBtn');
    const imageInput = document.getElementById('imageInput');

    // New modal elements
    const resultModal = document.getElementById('resultModal');
    const resultModalBody = document.getElementById('resultModalBody');
    const closeResultBtn = document.querySelector('#resultModal .close-result');

    // helper: get selected produce from radio buttons
    function getSelectedProduce() {
      const selected = document.querySelector('input[name="produce_type"]:checked');
      return selected ? selected.value : '';
    }

    // Hold id of image just analyzed
    let currentImageId = null;

    // Modal close handlers
    closeResultBtn.addEventListener('click', () => { resultModal.style.display = 'none'; });
    resultModal.addEventListener('click', (e) => {
      if (e.target === resultModal) resultModal.style.display = 'none';
    });

    submitBtn.addEventListener('click', async () => {
      if (!imageInput.files.length) {
        alert("Please upload an image first!");
        return;
      }

      const file = imageInput.files[0];
      const formData = new FormData();
      formData.append('image', file);

      const selectedProduce = getSelectedProduce();
      if (selectedProduce) formData.append('produce_type', selectedProduce);

      const response = await fetch('/predict/', { method: 'POST', body: formData });
      const data = await response.json();

      // Handle error
      if (data.error) {
        resultModalBody.innerHTML = `<p class="result-error">${data.error}</p>`;
        // Hide feedback box if there was an error
        document.getElementById('feedbackBox').style.display = 'none';
        currentImageId = null;
        resultModal.style.display = 'flex';
        return;
      }

      // Recall image ID for feedback
      currentImageId = data.image_id || null;

      // Always show feedback box after successful submission
      document.getElementById('feedbackBox').style.display = 'block';

      if (data.segmented_result) {
        const seg = data.segmented_result;
        const adjusted_freshness =
          ((seg.fresh_prob / (seg.fresh_prob + seg.rotten_prob)) * 100).toFixed(2);
        const freshnessNum = parseFloat(adjusted_freshness);
        const probSum = (seg.fresh_prob || 0) + (seg.rotten_prob || 0);

        // Validate that the model's probabilities are confident enough to show a
        // freshness result for the selected produce. If probabilities are low, show
        // an error message instead of the freshness bar.
        if (probSum < 0.7) {
          // Provide a helpful error message and hide the feedback controls.
          resultModalBody.innerHTML = `
            <h3>Results:</h3>
            <p><strong>Produce:</strong> ${seg.produce_type ? seg.produce_type.charAt(0).toUpperCase() + seg.produce_type.slice(1) : 'Selected produce'}</p>
            <p class="result-error">Confidence too low to compute an accurate freshness score. Please try another produce type or a clearer image.</p>
          `;
          // Hide the feedback box: feedback only makes sense when there's an analysis.
          document.getElementById('feedbackBox').style.display = 'none';
          currentImageId = data.image_id || null;
          // Show the modal and return early.
          resultModal.style.display = 'flex';
          return;
        }

        // Render the bar HTML into modal body
        resultModalBody.innerHTML = `
          <h3>Results:</h3>
          <p><strong>Status:</strong> ${adjusted_freshness} ${seg.status}</p>

          <div class="freshness-container">
            <div id="freshnessBar" class="freshness-bar" role="progressbar"
                aria-valuemin="0" aria-valuemax="100" aria-valuenow="${freshnessNum}">
              <div class="freshness-bar__fill"></div>
            </div>
          </div>
        `;

        const fill = resultModalBody.querySelector(".freshness-bar__fill");

        // Compute final color based on freshness (final RGB)
        let rFinal, gFinal, bFinal;
        if (freshnessNum <= 50) {
          // Red -> Orange
          const t = freshnessNum / 50; // 0.0 - 1.0
          rFinal = 255;
          gFinal = Math.round(165 * t);
          bFinal = 0;
        } else {
          // Orange -> Green
          const t = (freshnessNum - 50) / 50; // 0.0 - 1.0
          rFinal = Math.round(255 - 255 * t);       // 255->0
          gFinal = Math.round(165 + (128-165) * t); // 165->128
          bFinal = 0;
        }

        fill.style.width = '0%';
        fill.style.backgroundColor = 'rgb(255,0,0)';

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            fill.style.width = `${freshnessNum}%`;
            fill.style.backgroundColor = `rgb(${rFinal},${gFinal},${bFinal})`;
          });
        });

      }
      else {
        // Otherwise show top 3 predictions
        resultModalBody.innerHTML = `<h3>Top 3 Predictions:</h3>`;
        data.predictions.forEach((pred, idx) => {
          resultModalBody.innerHTML += `<p>${idx+1}. ${pred.label}: ${(pred.prob*100).toFixed(2)}%</p>`;
        });
      }

      // Show the modal (Option 1 behavior)
      resultModal.style.display = 'flex';
    });

    // ===== Preview JS =====
    const previewImage = document.getElementById('previewImage');
    const previewActions = document.getElementById('previewActions');
    const replaceBtn = document.getElementById('replaceBtn');
    const clearBtn = document.getElementById('clearBtn');

    function showPreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.classList.remove('is-hidden');
        previewActions.classList.remove('is-hidden');
      };
      reader.readAsDataURL(file);
    }

    function clearPreview() {
      imageInput.value = '';
      previewImage.src = '';
      previewImage.classList.add('is-hidden');
      previewActions.classList.add('is-hidden');
    }

    imageInput.addEventListener('change', () => {
      const file = imageInput.files && imageInput.files[0];
      if (file) showPreview(file);
      else clearPreview();
    });

    replaceBtn.addEventListener('click', () => imageInput.click());
    clearBtn.addEventListener('click', clearPreview);

    // ===== NEW: Produce Grey-out (only visual; still allows changing selection) =====
    document.addEventListener("DOMContentLoaded", function () {
      const grid = document.querySelector(".produce-grid");
      const radios = document.querySelectorAll(".produce-option input[type='radio']");

      radios.forEach(radio => {
        radio.addEventListener("change", () => {
          grid.classList.add("selected-active");
        });
      });
    });

    // ===== Modal / Help Button JS =====
    const helpBtn = document.getElementById('helpBtn');
    const modal = document.getElementById('instructionModal');
    const closeBtn = modal.querySelector('.close-btn');
    const dontShowCheckbox = document.getElementById('dontShowAgain');

    async function getPopupState() {
      try {
        const resp = await fetch("{% url 'get_instruction_popup_state' %}");
        if (!resp.ok) return;
        const data = await resp.json();
        dontShowCheckbox.checked = data.hide === true;
      } catch (err) { console.error(err); }
    }

    async function hidePopupIfNeeded() {
      const hide = dontShowCheckbox.checked;
      try {
        await fetch("{% url 'hide_instruction_popup' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({ hide })
        });
      } catch (err) { console.error(err); }
    }

    async function showModal() {
      await getPopupState(); // sync checkbox with backend
      modal.style.display = 'flex';
    }

    // Page load: auto show only if show_popup true
    if ("{{ show_popup }}".toLowerCase() === "true") modal.style.display = "flex";

    // Always opens on ?
    helpBtn.addEventListener('click', showModal);

    // Close modal
    closeBtn.addEventListener('click', async () => {
      await hidePopupIfNeeded();
      modal.style.display = 'none';
    });

    // Close on outside click
    modal.addEventListener('click', async (e) => {
      if (e.target === modal) {
        await hidePopupIfNeeded();
        modal.style.display = 'none';
      }
    });

    // Sync checkbox on page load
    getPopupState();

    // Feedback
    const feedbackSubmitBtn = document.getElementById('feedbackSubmitBtn');

    if (feedbackSubmitBtn) {
      feedbackSubmitBtn.addEventListener('click', async (event) => {
        event.preventDefault();

        const helpfulInput = document.querySelector('input[name="helpful"]:checked');
        const explanationInput = document.getElementById('feedbackExplanation');
        const messageSpan = document.getElementById('feedbackMessage');

        // Make sure user chooses Yes or No
        if (!helpfulInput) {
          messageSpan.innerText = 'Please choose Yes or No.';
          return;
        }

        // Make sure there is actually an image to analyze
        if (!currentImageId) {
          messageSpan.innerText = 'Please submit an image first.';
          return;
        }

        // Build data to send 
        const payload = {
          image_id: currentImageId,
          helpful: helpfulInput.value,
          explanation: explanationInput.value
        };

        try {
          const response = await fetch("{% url 'submit_feedback' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(payload)
          });

          const result = await response.json();

          if (result.success) {
            messageSpan.innerText = 'Thanks for your feedback!';
            feedbackSubmitBtn.disabled = true; // Prevents re-clicking
          } else {
            messageSpan.innerText = result.error || 'Error saving feedback.';
          }
        }
        catch (err) {
          console.error(err);
          messageSpan.innerText = 'Error submitting feedback.';
        }
      });
    }

    // ===== Auth Modal JS =====
    const authModal = document.getElementById('authModal');
    const authClose = document.querySelector('#authModal .auth-close');
    const authError = document.getElementById('authError');

    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const showSignup = document.getElementById('showSignup');
    const showLogin = document.getElementById('showLogin');

    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');

    const CSRF_TOKEN = '{{ csrf_token }}';

    function showAuthError(msg) {
      authError.textContent = msg || '';
      if (msg) authError.classList.remove('hidden');
      else authError.classList.add('hidden');
    }

    function openAuthModal() {
      showAuthError('');
      authModal.style.display = 'flex';
    }

    function closeAuthModal() {
      authModal.style.display = 'none';
    }

    // Show on first load (user requested modal pops up first)
    openAuthModal();

    authClose.addEventListener('click', () => {
      closeAuthModal();
    });

    // Toggle between login/signup
    showSignup.addEventListener('click', () => {
      loginForm.classList.add('hidden');
      signupForm.classList.remove('hidden');
      document.getElementById('authTitle').textContent = 'Create an account';
      showAuthError('');
    });
    showLogin.addEventListener('click', () => {
      signupForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      document.getElementById('authTitle').textContent = 'Welcome — Sign in';
      showAuthError('');
    });

    // Helper: post JSON with CSRF
    async function postJson(url, payload) {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(()=>({ error: 'Invalid response' }));
      return { ok: resp.ok, status: resp.status, data };
    }

    loginBtn.addEventListener('click', async () => {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!username || !password) return showAuthError('Please provide username and password');

      const { ok, data } = await postJson("{% url 'ajax_login' %}", { username, password });
      if (!ok) return showAuthError(data.error || 'Login failed');

      location.reload();
    });

    signupBtn.addEventListener('click', async () => {
      const username = document.getElementById('signupUsername').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      if (!username || !password) return showAuthError('Please provide username and password');

      const { ok, status, data } = await postJson("{% url 'ajax_signup' %}", { username, email, password });
      if (!ok) {
        return showAuthError(data.error || 'Signup failed');
      }

      location.reload();
    });

    // Close auth modal if click outside card
    authModal.addEventListener('click', (e) => {
      if (e.target === authModal) closeAuthModal();
    });
  </script>
</body>
</html>
