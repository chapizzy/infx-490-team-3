{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FoodLens - Sign Up / Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400&family=Raleway:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/signup.css' %}">
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="header-inner">
      <div class="brand">
        <img class="logo" src="{% static 'assets/logo2.svg' %}" alt="FoodLens logo">
        <span>FOOD</span><span class="orange">LENS</span>
      </div>
      <nav class="nav-links">
        <a href="/home/what-is-foodlens/" class="nav-link">What is FoodLens?</a>
        <a href="/home/faq/" class="nav-link">FAQ</a>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="auth-container">
      <!-- Login Form (shown by default) -->
      <div id="loginFormContainer" class="form-container visible">
        <div class="auth-card">
          <h2>Welcome Back</h2>
          
          <div id="loginError" class="auth-error"></div>
          <div id="loginSuccess" class="success-message"></div>

          <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="auth-field">
              <label for="loginUsername">Username</label>
              <input 
                id="loginUsername" 
                type="text" 
                name="username" 
                placeholder="Enter your username"
                required
                autocomplete="username">
            </div>

            <div class="auth-field">
              <label for="loginPassword">Password</label>
              <input 
                id="loginPassword" 
                type="password" 
                name="password" 
                placeholder="Enter your password"
                required
                autocomplete="current-password">
            </div>

            <button type="submit" class="btn" id="loginBtn">Sign In</button>
          </form>

          <div class="auth-toggle-section">
            <p class="auth-toggle-text">
              Don't have an account? 
              <button class="auth-toggle-link" onclick="switchToSignup()">Create one</button>
            </p>
          </div>

          <div class="auth-info">
            <strong>Demo Access:</strong> Use any username and password to explore FoodLens. Create a new account or use an existing one.
          </div>
        </div>
      </div>

      <!-- Signup Form (hidden by default) -->
      <div id="signupFormContainer" class="form-container hidden">
        <div class="auth-card">
          <h2>Create Account</h2>
          
          <div id="signupError" class="auth-error"></div>
          <div id="signupSuccess" class="success-message"></div>

          <form id="signupForm" onsubmit="handleSignup(event)">
            <div class="auth-field">
              <label for="signupUsername">Username</label>
              <input 
                id="signupUsername" 
                type="text" 
                name="username" 
                placeholder="Choose a username"
                required
                autocomplete="username"
                minlength="3">
              <small style="color: #999; font-size: 12px; margin-top: 4px; display: block;">At least 3 characters</small>
            </div>

            <div class="auth-field">
              <label for="signupEmail">Email <span style="color: #999;">(optional)</span></label>
              <input 
                id="signupEmail" 
                type="email" 
                name="email" 
                placeholder="Enter your email"
                autocomplete="email">
            </div>

            <div class="auth-field">
              <label for="signupPassword">Password</label>
              <input 
                id="signupPassword" 
                type="password" 
                name="password" 
                placeholder="Create a password"
                required
                autocomplete="new-password"
                minlength="6"
                oninput="checkPasswordStrength()">
              <small style="color: #999; font-size: 12px; margin-top: 4px; display: block;">At least 6 characters</small>
              
              <!-- Password Strength Indicator -->
              <div id="passwordStrengthContainer" class="password-strength" style="display: none;">
                <div class="strength-bar">
                  <div id="strengthFill" class="strength-fill"></div>
                </div>
                <div id="strengthText" class="strength-text"></div>
              </div>
            </div>

            <button type="submit" class="btn" id="signupBtn">Create Account</button>
          </form>

          <div class="auth-toggle-section">
            <p class="auth-toggle-text">
              Already have an account? 
              <button class="auth-toggle-link" onclick="switchToLogin()">Sign in</button>
            </p>
          </div>

          <div class="auth-info">
            <strong>Password Requirements:</strong> Use at least 6 characters. Combine letters, numbers, and symbols for better security.
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const CSRF_TOKEN = '{{ csrf_token }}';

    // ===== Form Switching =====
    function switchToSignup() {
      document.getElementById('loginFormContainer').classList.add('hidden');
      document.getElementById('loginFormContainer').classList.remove('visible');
      document.getElementById('signupFormContainer').classList.remove('hidden');
      document.getElementById('signupFormContainer').classList.add('visible');
      clearErrors();
    }

    function switchToLogin() {
      document.getElementById('signupFormContainer').classList.add('hidden');
      document.getElementById('signupFormContainer').classList.remove('visible');
      document.getElementById('loginFormContainer').classList.remove('hidden');
      document.getElementById('loginFormContainer').classList.add('visible');
      clearErrors();
    }

    // ===== Error / Success Display =====
    function showError(container, message) {
      const errorEl = document.getElementById(container);
      errorEl.textContent = message;
      errorEl.classList.add('visible');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showSuccess(container, message) {
      const successEl = document.getElementById(container);
      successEl.textContent = message;
      successEl.classList.add('visible');
    }

    function clearErrors() {
      document.getElementById('loginError').classList.remove('visible');
      document.getElementById('signupError').classList.remove('visible');
      document.getElementById('loginSuccess').classList.remove('visible');
      document.getElementById('signupSuccess').classList.remove('visible');
    }

    // ===== Password Strength Check =====
    function checkPasswordStrength() {
      const password = document.getElementById('signupPassword').value;
      const strengthContainer = document.getElementById('passwordStrengthContainer');
      const strengthFill = document.getElementById('strengthFill');
      const strengthText = document.getElementById('strengthText');

      if (!password) {
        strengthContainer.style.display = 'none';
        return;
      }

      strengthContainer.style.display = 'block';

      // Remove all strength classes
      strengthFill.className = 'strength-fill';
      strengthText.className = 'strength-text';

      let strength = 0;
      
      // Check length
      if (password.length >= 6) strength++;
      if (password.length >= 10) strength++;
      
      // Check for lowercase
      if (/[a-z]/.test(password)) strength++;
      
      // Check for uppercase
      if (/[A-Z]/.test(password)) strength++;
      
      // Check for numbers
      if (/[0-9]/.test(password)) strength++;
      
      // Check for special characters
      if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) strength++;

      // Determine strength level
      if (strength < 2) {
        strengthFill.classList.add('weak');
        strengthText.classList.add('weak');
        strengthText.textContent = 'Weak password';
      } else if (strength < 4) {
        strengthFill.classList.add('medium');
        strengthText.classList.add('medium');
        strengthText.textContent = 'Medium password';
      } else {
        strengthFill.classList.add('strong');
        strengthText.classList.add('strong');
        strengthText.textContent = 'Strong password';
      }
    }

    // ===== Login Handler =====
    async function handleLogin(event) {
      event.preventDefault();
      clearErrors();

      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');

      if (!username || !password) {
        showError('loginError', 'Please enter both username and password');
        return;
      }

      // Disable button and show loading state
      loginBtn.disabled = true;
      loginBtn.classList.add('loading');
      loginBtn.textContent = 'Signing in...';

      try {
        const response = await fetch("{% url 'ajax_login' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
          },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (!response.ok) {
          showError('loginError', data.error || 'Login failed. Please try again.');
          loginBtn.disabled = false;
          loginBtn.classList.remove('loading');
          loginBtn.textContent = 'Sign In';
          return;
        }

        // Success
        showSuccess('loginSuccess', `Welcome back, ${data.username}! Redirecting...`);
        setTimeout(() => {
          window.location.href = "/home/";
        }, 1500);
      } catch (error) {
        console.error('Login error:', error);
        showError('loginError', 'An error occurred. Please try again.');
        loginBtn.disabled = false;
        loginBtn.classList.remove('loading');
        loginBtn.textContent = 'Sign In';
      }
    }

    // ===== Signup Handler =====
    async function handleSignup(event) {
      event.preventDefault();
      clearErrors();

      const username = document.getElementById('signupUsername').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const signupBtn = document.getElementById('signupBtn');

      if (!username || !password) {
        showError('signupError', 'Please enter username and password');
        return;
      }

      if (username.length < 3) {
        showError('signupError', 'Username must be at least 3 characters');
        return;
      }

      if (password.length < 6) {
        showError('signupError', 'Password must be at least 6 characters');
        return;
      }

      // Disable button and show loading state
      signupBtn.disabled = true;
      signupBtn.classList.add('loading');
      signupBtn.textContent = 'Creating account...';

      try {
        const response = await fetch("{% url 'ajax_signup' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
          },
          body: JSON.stringify({ username, email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          showError('signupError', data.error || 'Signup failed. Please try again.');
          signupBtn.disabled = false;
          signupBtn.classList.remove('loading');
          signupBtn.textContent = 'Create Account';
          return;
        }

        // Success
        showSuccess('signupSuccess', `Account created! Welcome, ${data.username}! Redirecting...`);
        setTimeout(() => {
          window.location.href = "/home/";
        }, 1500);
      } catch (error) {
        console.error('Signup error:', error);
        showError('signupError', 'An error occurred. Please try again.');
        signupBtn.disabled = false;
        signupBtn.classList.remove('loading');
        signupBtn.textContent = 'Create Account';
      }
    }

    // ===== Keyboard Navigation =====
    document.addEventListener('DOMContentLoaded', function() {
      // Allow Enter key to submit forms
      document.getElementById('loginForm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin(e);
      });

      document.getElementById('signupForm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleSignup(e);
      });
    });
  </script>
</body>
</html>
