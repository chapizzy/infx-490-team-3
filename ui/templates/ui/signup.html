{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FoodLens - Sign Up / Login</title>

  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400&family=Raleway:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/signup.css' %}">
  <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
</head>

<body>

  <!-- âœ… Sidebar + Hamburger -->
  {% include "partials/sidebar.html" %}

  <!-- Header -->
  <header class="site-header">
    <div class="header-inner">
      <div class="brand">
        <img class="logo" src="{% static 'assets/logo2.svg' %}" alt="FoodLens logo">
        <span>FOOD</span><span class="orange">LENS</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="auth-container">

      <!-- LOGIN FORM -->
      <div id="loginFormContainer" class="form-container visible">
        <div class="auth-card">
          <h2>Welcome Back</h2>

          <div id="loginError" class="auth-error"></div>
          <div id="loginSuccess" class="success-message"></div>

          <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="auth-field">
              <label for="loginUsername">Username</label>
              <input 
                id="loginUsername" 
                type="text" 
                name="username" 
                placeholder="Enter your username"
                required
                autocomplete="username">
            </div>

            <div class="auth-field">
              <label for="loginPassword">Password</label>
              <input 
                id="loginPassword" 
                type="password" 
                name="password" 
                placeholder="Enter your password"
                required
                autocomplete="current-password">
            </div>

            <button type="submit" class="btn" id="loginBtn">Sign In</button>
          </form>

          <div class="auth-toggle-section">
            <p class="auth-toggle-text">
              Don't have an account?
              <button class="auth-toggle-link" onclick="switchToSignup()">Create one</button>
            </p>
          </div>

          <div class="auth-info">
            <strong>Demo Access:</strong> Use any username and password to explore FoodLens.
          </div>
        </div>
      </div>

      <!-- SIGNUP FORM -->
      <div id="signupFormContainer" class="form-container hidden">
        <div class="auth-card">
          <h2>Create Account</h2>

          <div id="signupError" class="auth-error"></div>
          <div id="signupSuccess" class="success-message"></div>

          <form id="signupForm" onsubmit="handleSignup(event)">
            <div class="auth-field">
              <label for="signupUsername">Username</label>
              <input 
                id="signupUsername" 
                type="text" 
                name="username" 
                placeholder="Choose a username"
                required
                autocomplete="username"
                minlength="3">
            </div>

            <div class="auth-field">
              <label for="signupEmail">Email <span style="color:#999;">(optional)</span></label>
              <input 
                id="signupEmail" 
                type="email" 
                name="email" 
                placeholder="Enter your email"
                autocomplete="email">
            </div>

            <div class="auth-field">
              <label for="signupPassword">Password</label>
              <input 
                id="signupPassword" 
                type="password" 
                name="password" 
                placeholder="Create a password"
                required
                autocomplete="new-password"
                minlength="6"
                oninput="checkPasswordStrength()">
            </div>

            <!-- Password Strength -->
            <div id="passwordStrengthContainer" class="password-strength" style="display:none;">
              <div class="strength-bar">
                <div id="strengthFill" class="strength-fill"></div>
              </div>
              <div id="strengthText" class="strength-text"></div>
            </div>

            <button type="submit" class="btn" id="signupBtn">Create Account</button>
          </form>

          <div class="auth-toggle-section">
            <p class="auth-toggle-text">
              Already have an account?
              <button class="auth-toggle-link" onclick="switchToLogin()">Sign in</button>
            </p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script>
    const CSRF_TOKEN = '{{ csrf_token }}';

    function switchToSignup() {
      document.getElementById('loginFormContainer').classList.add('hidden');
      document.getElementById('signupFormContainer').classList.remove('hidden');
    }

    function switchToLogin() {
      document.getElementById('signupFormContainer').classList.add('hidden');
      document.getElementById('loginFormContainer').classList.remove('hidden');
    }

    function showError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.add('visible');
    }

    function showSuccess(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.classList.add('visible');
    }

    // Login handler
    async function handleLogin(e) {
      e.preventDefault();
      const username = loginUsername.value.trim();
      const password = loginPassword.value;

      const response = await fetch("{% url 'ajax_login' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": CSRF_TOKEN },
        body: JSON.stringify({ username, password })
      });

      const data = await response.json();

      if (!response.ok) return showError("loginError", data.error);

      showSuccess("loginSuccess", "Logged in! Redirecting...");
      setTimeout(() => window.location.href = "/home/", 1200);
    }

    // Signup handler
    async function handleSignup(e) {
      e.preventDefault();
      const username = signupUsername.value.trim();
      const email = signupEmail.value.trim();
      const password = signupPassword.value;

      const response = await fetch("{% url 'ajax_signup' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": CSRF_TOKEN },
        body: JSON.stringify({ username, email, password })
      });

      const data = await response.json();

      if (!response.ok) return showError("signupError", data.error);

      showSuccess("signupSuccess", "Account created! Redirecting...");
      setTimeout(() => window.location.href = "/home/", 1200);
    }
  </script>
</body>
</html>
